{% comment %}
  Futon Quiz - Single Collection with Tag-Based Product Selection
  Uses product tags to categorize products instead of multiple collections
{% endcomment %}

<section class="futon-quiz-section py-16">
  <div class="container mx-auto px-4">
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-foreground mb-4">{{ section.settings.quiz_title }}</h1>
      <p class="text-lg text-muted-foreground max-w-2xl mx-auto">{{ section.settings.quiz_subtitle }}</p>
    </div>

    <!-- Quiz Steps (Blocks) -->
    <div id="quiz-container" class="bg-background">
      {% for block in section.blocks %}
        {% case block.type %}
          {% when 'start_step' %}
            <!-- Your existing start step block code -->
            
          {% when 'people_count_step' %}
            <!-- Your existing people count step block code -->
            
          {% comment %} Add all other existing step blocks here {% endcomment %}
        {% endcase %}
      {% endfor %}
    </div>
  </div>

  {%- comment -%} Single Collection Product Data with Tag-Based Categorization {%- endcomment -%}
  <script type="application/json" id="quiz-products-data">
    {
      "products": [
        {%- for product in collections[section.settings.product_collection].products limit: 50 -%}
          {
            "id": {{ product.id | json }},
            "handle": {{ product.handle | json }},
            "title": {{ product.title | json }},
            "price": {{ product.price | json }},
            "compare_at_price": {{ product.compare_at_price | json }},
            "featured_image": {{ product.featured_image | image_url: width: 400 | json }},
            "url": {{ product.url | json }},
            "description": {{ product.description | truncate: 200 | json }},
            "tags": {{ product.tags | json }},
            "vendor": {{ product.vendor | json }},
            "variants": [
              {%- for variant in product.variants limit: 5 -%}
                {
                  "id": {{ variant.id | json }},
                  "title": {{ variant.title | json }},
                  "price": {{ variant.price | json }},
                  "available": {{ variant.available | json }}
                }{%- unless forloop.last -%},{%- endunless -%}
              {%- endfor -%}
            ],
            {%- comment -%} Tag-based attributes for easy filtering {%- endcomment -%}
            "attributes": {
              "firmness": [
                {%- for tag in product.tags -%}
                  {%- assign tag_lower = tag | downcase -%}
                  {%- if tag_lower contains 'soft' or tag_lower contains 'blød' -%}
                    "soft"
                  {%- elsif tag_lower contains 'medium' -%}
                    "medium"  
                  {%- elsif tag_lower contains 'hard' or tag_lower contains 'fast' -%}
                    "hard"
                  {%- endif -%}
                  {%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              ],
              "suitability": [
                {%- for tag in product.tags -%}
                  {%- assign tag_lower = tag | downcase -%}
                  {%- if tag_lower contains 'couple' or tag_lower contains 'par' -%}
                    "couples"
                  {%- elsif tag_lower contains 'single' or tag_lower contains 'enkelt' -%}
                    "single"
                  {%- elsif tag_lower contains 'side-sleeper' or tag_lower contains 'sideligger' -%}
                    "side-sleeper"
                  {%- elsif tag_lower contains 'back-sleeper' or tag_lower contains 'rygligger' -%}
                    "back-sleeper"
                  {%- elsif tag_lower contains 'stomach-sleeper' or tag_lower contains 'maveligger' -%}
                    "stomach-sleeper"
                  {%- endif -%}
                  {%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              ],
              "weight_support": [
                {%- for tag in product.tags -%}
                  {%- assign tag_lower = tag | downcase -%}
                  {%- if tag_lower contains 'light-weight' or tag_lower contains 'let' -%}
                    "light"
                  {%- elsif tag_lower contains 'heavy-weight' or tag_lower contains 'tung' -%}
                    "heavy"
                  {%- elsif tag_lower contains 'plus-size' or tag_lower contains 'stor-størrelse' -%}
                    "plus-size"
                  {%- endif -%}
                  {%- unless forloop.last -%},{%- endunless -%}
                {%- endfor -%}
              ]
            }
          }{%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      ]
    }
  </script>
</section>

{%- comment -%} Quiz Configuration {%- endcomment -%}
<script>
  window.quizConfig = {
    productCollection: "{{ section.settings.product_collection.id | default: '' }}",
    shopUrl: "{{ shop.permanent_domain }}",
    totalSteps: {{ section.blocks.size }},
    
    // Tag mapping configuration
    tagMappings: {
      firmness: {
        soft: {{ section.settings.soft_tags | split: ',' | json }},
        medium: {{ section.settings.medium_tags | split: ',' | json }},
        hard: {{ section.settings.hard_tags | split: ',' | json }}
      },
      sleepPosition: {
        side: {{ section.settings.side_sleeper_tags | split: ',' | json }},
        back: {{ section.settings.back_sleeper_tags | split: ',' | json }},
        stomach: {{ section.settings.stomach_sleeper_tags | split: ',' | json }}
      },
      couples: {{ section.settings.couples_tags | split: ',' | json }},
      weightSupport: {
        light: {{ section.settings.light_weight_tags | split: ',' | json }},
        heavy: {{ section.settings.heavy_weight_tags | split: ',' | json }}
      }
    }
  };
</script>
{{ 'futon-quiz-single-collection.js' | asset_url | script_tag }}

{% schema %}
{
  "name": "Futon Quiz (Single Collection)",
  "tag": "section",
  "class": "futon-quiz-section",
  "settings": [
    {
      "type": "header",
      "content": "Quiz Configuration"
    },
    {
      "type": "text",
      "id": "quiz_title",
      "label": "Quiz Titel",
      "default": "Find Din Perfekte Futon"
    },
    {
      "type": "textarea",
      "id": "quiz_subtitle", 
      "label": "Quiz Undertitel",
      "default": "Tag vores personlige test og få anbefalinger tilpasset dine behov"
    },
    {
      "type": "header",
      "content": "Product Collection"
    },
    {
      "type": "collection",
      "id": "product_collection",
      "label": "Futon Products Collection",
      "info": "Main collection containing all futon products to recommend"
    },
    {
      "type": "header",
      "content": "Tag Mappings - Firmness"
    },
    {
      "type": "text",
      "id": "soft_tags",
      "label": "Soft Firmness Tags",
      "default": "soft,blød,plush,mjuk",
      "info": "Comma-separated tags for soft products"
    },
    {
      "type": "text", 
      "id": "medium_tags",
      "label": "Medium Firmness Tags",
      "default": "medium,medium-fast,balanced",
      "info": "Comma-separated tags for medium firmness products"
    },
    {
      "type": "text",
      "id": "hard_tags", 
      "label": "Hard Firmness Tags",
      "default": "hard,fast,firm,stiv",
      "info": "Comma-separated tags for firm products"
    },
    {
      "type": "header",
      "content": "Tag Mappings - Sleep Positions"
    },
    {
      "type": "text",
      "id": "side_sleeper_tags",
      "label": "Side Sleeper Tags", 
      "default": "side-sleeper,sideligger,side-sleep",
      "info": "Comma-separated tags for products good for side sleepers"
    },
    {
      "type": "text",
      "id": "back_sleeper_tags",
      "label": "Back Sleeper Tags",
      "default": "back-sleeper,rygligger,back-sleep", 
      "info": "Comma-separated tags for products good for back sleepers"
    },
    {
      "type": "text",
      "id": "stomach_sleeper_tags",
      "label": "Stomach Sleeper Tags",
      "default": "stomach-sleeper,maveligger,stomach-sleep",
      "info": "Comma-separated tags for products good for stomach sleepers"
    },
    {
      "type": "header", 
      "content": "Tag Mappings - Special Categories"
    },
    {
      "type": "text",
      "id": "couples_tags",
      "label": "Couples Tags",
      "default": "couples,par,double,king,queen",
      "info": "Comma-separated tags for products good for couples"
    },
    {
      "type": "text",
      "id": "light_weight_tags", 
      "label": "Light Weight Support Tags",
      "default": "light-weight,let,under-70kg",
      "info": "Comma-separated tags for products good for lighter people"
    },
    {
      "type": "text",
      "id": "heavy_weight_tags",
      "label": "Heavy Weight Support Tags", 
      "default": "heavy-weight,tung,over-90kg,plus-size",
      "info": "Comma-separated tags for products good for heavier people"
    }
  ],
  "blocks": [
    {
      "type": "start_step", 
      "name": "Start Trin",
      "limit": 1
    },
    {
      "type": "people_count_step",
      "name": "Antal Personer Trin", 
      "limit": 1
    }
  ],
  "presets": [
    {
      "name": "Futon Quiz (Single Collection)",
      "blocks": [
        {
          "type": "start_step"
        },
        {
          "type": "people_count_step"
        }
      ]
    }
  ]
}
{% endschema %}